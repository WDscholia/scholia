{% extends "bootstrap-base.html" %}

{% macro sparql_to_table_post(panel, options={}) -%}
// {{ panel }} table
sparqlToDataTablePost(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}
`,
"#{{ panel }}-table", "{{ aspect }}_{{ panel }}.sparql",
options={{ options | tojson }});
{%- endmacro %}

{% macro sparql_to_table(panel, options={}) -%}
// {{ panel }} table
sparqlToDataTable(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}
`,
"#{{ panel }}-table", "{{ aspect }}_{{ panel }}.sparql",
options={{ options | tojson }});
{%- endmacro %}

{% macro sparql_to_iframe(panel) -%}
// {{ panel }} iframe
sparqlToIframe(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}`,
"#{{ panel }}-iframe", "{{ aspect }}_{{ panel }}.sparql");
{%- endmacro %}

{% macro sparql_to_matrix(panel) -%}
// {{ panel }} matrix
sparqlToMatrix(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}`,
"#{{ panel }}", "{{ aspect }}_{{ panel }}.sparql");
{%- endmacro %}

{% macro sparql_to_pathway_viewer(panel) -%}
// {{ panel }} optional viewer
sparqlToPathWayPageViewer(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}`,
"{{ aspect }}_{{ panel }}.sparql" );
{%- endmacro %}

{% macro sparql_to_404shortinchikey(panel) -%}
// {{ panel }} short_inchikey
sparqlToShortInchiKey(`# tool: scholia
{% include aspect + '_' + panel + '.sparql' %}`,
"{{inchikey}}",
"#{{ panel }}-table", "{{ aspect }}_{{ panel }}.sparql" );
{%- endmacro %}


{% block metas %}
<meta charset="UTF-8">
<meta name="robots" content="index, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="og:url" content="{{ 'https://scholia.toolforge.org' + request.path }}" />
<meta name="og:site_name" content="Scholia" />
<meta name="og:image" content="{{ url_for('static', filename='images/scholia_social_media.png') }}" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@WDScholia" />
{% endblock metas %}


{% block head %}
{{super()}}

<link rel="canonical" href="{{ 'https://scholia.toolforge.org' + request.path }}">

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jquery.dataTables.min.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/scholia.css') }}">
{% include "favicon.html" %}

{% endblock %}

{% block title %}Scholia{% endblock %}

{% block scripts %}
{{super()}}

<script type="text/javascript" src="{{ url_for('static', filename='d3.v5.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3-scale-chromatic.v1.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jquery.dataTables.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='scholia.js') }}"></script>

<script type="text/javascript" src="{{ url_for('static', filename='bootstrap-autocomplete.min.js')}}"></script>

<script type="text/javascript">
    {% if q %}
    var url = 'https://www.wikidata.org/w/api.php?action=wbgetentities&ids=' +
	       '{{ q }}' + 
	       '&format=json&callback=?';
     
    $.getJSON(url, function (data) {
	 var item = data.entities["{{ q }}"];
	 if ('en' in item.labels) {
	     var title = item.labels.en.value
	     $("#h1").text(title);
       $("title").text(title + " - Scholia");

	     {% if request.path.endswith("curation") or request.path.endswith("curation/") %}

	     var linkedToFrom = "<p><a href='https://www.wikidata.org/w/index.php?hidecategorization=1&target={{ q }}&showlinkedto=1&limit=500&days=7&enhanced=1&title=Special:RecentChangesLinked&urlversion=2' >";
	     linkedToFrom += "Recent changes to items that link <em>to</em> " + $('<div>').text(title).html() + "</a> and ";
	     linkedToFrom += "<a href='https://www.wikidata.org/w/index.php?hidecategorization=1&target={{ q }}&showlinkedto=0&limit=500&days=7&enhanced=1&title=Special:RecentChangesLinked&urlversion=2' >";
	     linkedToFrom += "recent changes to items that link <em>from</em> " + $('<div>').text(title).html() + "</a>.</p>";

	     $(linkedToFrom).insertAfter('h1:first');

	     {% endif %}
	 }
	 $("#h1").append(' (<a href="https://www.wikidata.org/wiki/{{ q }}">{{ q }}</a>)');

    {% if q2 %}

    var url2 = 'https://www.wikidata.org/w/api.php?action=wbgetentities&ids=' +
               '{{ q2 }}' +
               '&format=json&callback=?';
    $.getJSON(url2, function (data) {
         var item = data.entities["{{ q2 }}"];
         if ('en' in item.labels) {
             $("#h1").append(' - '+item.labels.en.value);
         }
         $("#h1").append(' (<a href="https://www.wikidata.org/wiki/{{ q2 }}">{{ q2 }}</a>)');
    });
    {% endif %}

	if ("P18" in item.claims) {
	    var imageName = item.claims.P18[0].mainsnak.datavalue.value;
	    // spaces must be replaced by underscores in the file name
	    imageName = imageName.replaceAll(" ", "_")
	    var imageNameMd5 = md5(imageName);
	    var imageURL = "https://upload.wikimedia.org/wikipedia/commons/" 
	    imageURL += imageNameMd5[0] + "/" + imageNameMd5.slice(0,2) + "/"
	    imageURL += encodeURIComponent(imageName);
	    var itemImage = document.getElementById("item-image");
	    if (itemImage) {
		itemImage.src = imageURL;
		itemImage.setAttribute('alt', imageName);
	    }
	}

	function socialMediaLink(detailsList, user, site, logo = '') {
	     var html = '';
	     if (logo) {
	        html += '<a href="' + site.url + '"><img alt="' + site.name + ' logo" src="';
	        html += logo.src + '" width="16" height="16" hspace="4" /></a> ';
	     }
	     html += '<a href="' + site.url + encodeURI(user.name) + '">';
	     html += user.prefix + escapeHTML(user.name) + '</a>';
	     detailsList.push(html);
	 }

	 var detailsList = Array();
	 if ("P496" in item.claims) {
	     var user = {name: item.claims.P496[0].mainsnak.datavalue.value, prefix: 'https://orcid.org/'};
		   var site = {name: "ORCID", url: "https://orcid.org/"};
		   var logo = {src: "{{ url_for('static', filename='images/orcid.svg') }}"};
		   socialMediaLink(detailsList, user, site, logo);
	 }

	 if ("P4033" in item.claims) {
	      var mastodonAccount = item.claims.P4033[0].mainsnak.datavalue.value;
	      var mastodonComponents = mastodonAccount.split("@");
	      if (mastodonComponents.length == 2) {
	        // Mastodon user URLs start with @
	        var user = { name: '@' + mastodonComponents[0], prefix: '' };
	        var site = { name: "Mastodon", url: 'https://' + mastodonComponents[1] + '/' };
	        var logo = { src: "{{ url_for('static', filename='images/mastodon.svg') }}" };
	        socialMediaLink(detailsList, user, site, logo);
	     }
	 }

	 if ("P2002" in item.claims) {
	     var user = {name: item.claims.P2002[0].mainsnak.datavalue.value, prefix: "@"};
	     var site = { name: "Twitter", url: "https://twitter.com/" };
	     var logo = { src: "{{ url_for('static', filename='images/twitter.svg') }}" };
	     socialMediaLink(detailsList, user, site, logo);
	 }

	 if ("P6782" in item.claims) {
	     var user = { name: item.claims.P6782[0].mainsnak.datavalue.value, prefix: 'https://ror.org/' };
	     var site = { name: "Research Organization Registry", url: 'https://ror.org/' };
	     var logo = { src: "{{ url_for('static', filename='images/ror.svg') }}" };
	     socialMediaLink(detailsList, user, site, logo);
	 }

	 if ("P2572" in item.claims) {
	     var user = { name: item.claims.P2572[0].mainsnak.datavalue.value, prefix: '#' };
	     var site = { name: "Hashtag hub", url: 'https://hashtags-hub.toolforge.org/' };
	     socialMediaLink(detailsList, user, site);
	 }

	 if (detailsList.length > 0) {
	     $('#details').append(detailsList.join(" | "));
	 }

	 try {
	     var doi = item.claims.P356[0].mainsnak.datavalue.value;
	     $("head").append( '<meta name="citation_doi" content="' + doi + '"/>' );
	 }
	 catch(e) {}
	 
	 /* BioSchemas annotation */
	 if (item.claims.P31 &&
	     ((item.claims.P31[0].mainsnak.datavalue.value.id == 'Q5'))) {
	   try { /* Person */
	       bioschemasAnnotation = {
	          "@context" : "https://schema.org",
	          "@type" : "Person" ,
	          "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/Person/0.2-DRAFT-2019_07_19/" },
	          "description" : "A person" ,
	          "identifier" : "{{ q }}" ,
	          "mainEntityOfPage" : "http://www.wikidata.org/entity/{{ q }}"
	       }
	       if ('en' in item.labels) {
	         bioschemasAnnotation.name = item.labels.en.value;
	       }
	       $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
	    } catch(e) {}
	 } else if (item.claims.P31 &&
	     ((item.claims.P31[0].mainsnak.datavalue.value.id == 'Q47461491') ||
	      (item.claims.P31[0].mainsnak.datavalue.value.id == 'Q967847'))) {
	   try { /* ChemicalSubstance */
	       bioschemasAnnotation = {
	          "@context" : "https://schema.org",
	          "@type" : "ChemicalSubstance" ,
	          "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/ChemicalSubstance/0.4-RELEASE/" },
	          "identifier" : "{{ q }}" ,
	          "url" : "http://www.wikidata.org/entity/{{ q }}"
	       }
	       if ('en' in item.labels) {
	         bioschemasAnnotation.name = item.labels.en.value;
	       }
	       $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
	    } catch(e) {}
	 } else if (item.claims.P225) {
             try { /* Taxon */
		 var taxonName = item.claims.P225[0].mainsnak.datavalue.value;
		 bioschemasAnnotation = {
	             "@context" : "https://schema.org",
	             "@type" : "Taxon" ,
	             "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/Taxon/0.6-RELEASE/" },
	             "name" : taxonName ,
	             "url" : "http://www.wikidata.org/entity/{{ q }}"
		 }
		 if (item.claims.P105) {
	             var taxonRank = item.claims.P105[0].mainsnak.datavalue.value.id;
	             bioschemasAnnotation.taxonRank = "http://www.wikidata.org/entity/" + taxonRank ;
		 }
		 if (item.claims.P171) {
	             var parent = item.claims.P171[0].mainsnak.datavalue.value.id;
	             bioschemasAnnotation.parentTaxon = "http://www.wikidata.org/entity/" + parent ;
		 }
		 $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
		 // console.log(JSON.stringify(bioschemasAnnotation, "", 2))
	     } catch(e) {}
	 } else if (item.claims.P235) {
	     try { /* Chemical Compound */
		 var inchiKey = item.claims.P235[0].mainsnak.datavalue.value;
		 bioschemasAnnotation = {
	             "@context" : "https://schema.org",
	             "@type" : "MolecularEntity" ,
	             "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/MolecularEntity/0.5-RELEASE/" },
	             "identifier" : "{{ q }}" ,
	             "inChIKey" : inchiKey ,
	             "url" : "http://www.wikidata.org/entity/{{ q }}"
		 }
		 if ('en' in item.labels) {
	         bioschemasAnnotation.name = item.labels.en.value;
         }
		 if (item.claims.P234 && item.claims.P234[0].mainsnak.datavalue) {
	             var inchi = item.claims.P234[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.inChI = inchi ;
		 }
		 if (item.claims.P274 && item.claims.P274[0].mainsnak.datavalue) {
	             var chemformula = item.claims.P274[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.molecularFormula = chemformula ;
		 }
		 if (item.claims.P2017 && item.claims.P2017[0].mainsnak.datavalue) {
	             var smiles = item.claims.P2017[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.molecularFormula = smiles.replace("\"", "\'\'") ;
		 } else if (item.claims.P233 && item.claims.P233[0].mainsnak.datavalue) {
	             var smiles = item.claims.P233[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.smiles = smiles.replace("\"", "\'\'") ;
		 }
		 $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
	     } catch(e) { console.log("Exception: " + e)
	     }
	 } else if (item.claims.P352) { // UniProt ID
	     try { /* Protein */
		 var uniprot = item.claims.P352[0].mainsnak.datavalue.value;
		 bioschemasAnnotation = {
	             "@context" : "https://schema.org",
	             "@type" : "Protein" ,
	             "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/Protein/0.11-RELEASE/" },
	             "identifier" : "{{ q }}" ,
	             "url" : "http://www.wikidata.org/entity/{{ q }}" ,
	             "sameAs": "https://www.uniprot.org/uniprot/" + uniprot
		 }
		 if ('en' in item.labels) {
	       bioschemasAnnotation.name = item.labels.en.value;
         }
		 $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
	     } catch(e) { console.log("Exception: " + e)
	     }
	 } else if (item.claims.P351 || item.claims.P594) { // NCBI Gene or Ensembl
	     try { /* Gene */
		 bioschemasAnnotation = {
	             "@context" : "https://schema.org",
	             "@type" : "Gene" ,
	             "http://purl.org/dc/terms/conformsTo": { "@type": "CreativeWork", "@id": "https://bioschemas.org/profiles/Gene/0.7-RELEASE/" },
	             "identifier" : "{{ q }}" ,
	             "url" : "http://www.wikidata.org/entity/{{ q }}"
		 }
		 if ('en' in item.labels) {
	       bioschemasAnnotation.name = item.labels.en.value;
         }
		 counter = 0
		 bioschemasAnnotation.sameAs = []
		 if (item.claims.P351 && item.claims.P351[0].mainsnak.datavalue) {
	             var ncbi = item.claims.P351[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.sameAs[counter] = "https://www.ncbi.nlm.nih.gov/gene/" + ncbi;
	             counter++
		 }
		 if (item.claims.P594 && item.claims.P594[0].mainsnak.datavalue) {
	             var ensembl = item.claims.P594[0].mainsnak.datavalue.value;
	             bioschemasAnnotation.sameAs[counter] = "http://identifiers.org/ensembl/" + ensembl;
		 }
		 $( '#bioschemas' ).append( JSON.stringify(bioschemasAnnotation) );
	     } catch(e) { console.log("Exception: " + e)
	     }
	 }
	 
	 /* English Wikipedia */
	 if ('enwiki' in item.sitelinks) {
	     var title = item.sitelinks.enwiki.title;
	     var wikipediaApiUrl = 'https://en.wikipedia.org/api/rest_v1/page/summary/' +
				   encodeURIComponent(title);
	     var wikipediaUrl = 'https://en.wikipedia.org/wiki/' + encodeURIComponent(title)

	     var headers = new Headers({"Api-User-Agent": "https://github.com/WDscholia/scholia"});

	     fetch(wikipediaApiUrl, {method: 'GET', headers: headers})
	     .then(response => response.json())
	     .then(data => {
	       var html = " (<a href=\"" + wikipediaUrl + "\">Read more on English Wikipedia</a>)";
		 $("#intro").text(data.extract).append(html);
	     }).catch(error => {
		 console.error('Error:', error);
	     });
	 }

	 
	 /* English Wikiversity */
	 if ('enwikiversity' in item.sitelinks) {
	     var enwikiversityTitle = item.sitelinks.enwikiversity.title;
	     var wikiversityApiUrl = 'https://en.wikiversity.org/w/api.php?' +
				     'action=query&prop=extracts&exsentences=3&exlimit=1&exintro=1&' + 
				     'explaintext=1&callback=?&format=json&titles=' +
				     encodeURIComponent(enwikiversityTitle);
	     var wikiversityUrl = 'https://en.wikiversity.org/wiki/' + encodeURIComponent(enwikiversityTitle)

	     $.getJSON(wikiversityApiUrl, function(data) {
		 var pages = data.query.pages;
		 var text = pages[Object.keys(pages)[0]].extract; 
		 if (text) {
		     var html = "... (from the <a href=\"" + wikiversityUrl + "\">English Wikiversity</a>)";
		 }
		 else {
		     var html = "Read on the <a href=\"" + wikiversityUrl + "\">English Wikiversity</a>";
		 }
		 $("#wikiversity-extract").text(text).append(html);
	     }).fail(function(d, textStatus, error) {
		 console.error("getJSON failed, status: " + textStatus + ", error: "+error)
	     });
	 }

     });
	
    var currentURL  = window.location.pathname.split("/")
    var currentAspect = currentURL[1];
    var curation = document.getElementById("curation-link");
    if (currentURL[3] == "curation") {
      curation.innerText = "Back"
      curation.href = "/" + currentAspect + "/{{ q }}";
    } else {
      curation.href = "/" + currentAspect + "/{{ q }}/curation";
    }
    curation.classList.remove("d-none");

     // this query opens the Wikidata item as a different aspect
     var endpointUrl = 'https://query.wikidata.org/sparql';
    if ("{{q2}}".length) {
        var query = `
    SELECT DISTINCT ?aspect 
    WHERE {
    { [] wdt:P17 wd:{{ q }} . BIND("country" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P159? / wdt:P625 [] . BIND("location" AS ?aspect) } 
    UNION 
    { [] wdt:P1416 | wdt:P108 wd:{{ q }} . BIND("organization" AS ?aspect) }
    }
    `;
    } else {
     var query = `
    SELECT DISTINCT ?aspect 
    WHERE {
    { [] wdt:P50 wd:{{ q }} . BIND("author" AS ?aspect) }
    UNION 
    { [] wdt:P166 wd:{{ q }} . BIND("award" AS ?aspect) }
    UNION 
    { [] wdt:P17 wd:{{ q }} . BIND("country" AS ?aspect) }
    UNION
    { [] wdt:P972 wd:{{ q }} . BIND("catalogue" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P159? / wdt:P625 [] . BIND("location" AS ?aspect) } 
    UNION 
    { [] wdt:P1416 | wdt:P108 wd:{{ q }} . BIND("organization" AS ?aspect) }
    UNION 
    { [] wdt:P123 wd:{{ q }} . BIND("publisher" AS ?aspect) }
    UNION 
    { [] wdt:P872 wd:{{ q }} . BIND("printer" AS ?aspect) }
    UNION 
    { [] wdt:P179 wd:{{ q }} . BIND("series" AS ?aspect) }
    UNION 
    { [] wdt:P859 wd:{{ q }} . BIND("sponsor" AS ?aspect) }
    UNION
    { [] wdt:P921 wd:{{ q }} . BIND("topic" AS ?aspect) }
    UNION
    { [] wdt:P4510 wd:{{ q }} . BIND("use" AS ?aspect) } 
    UNION
    { [] wdt:P1433 wd:{{ q }} . BIND("venue" AS ?aspect) } 
    UNION
    { wd:{{ q }} wdt:P235 [] . BIND("chemical" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P225 [] . BIND("taxon" AS ?aspect) }
    UNION
    { wd:{{ q }} ^wdt:P31/wdt:P235 [] . BIND("chemical-class" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P644 [] . BIND("gene" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P31 / wdt:P279?  wd:Q22325163 . BIND("complex" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P31 wd:Q8054 . BIND("protein" AS ?aspect) }
    UNION
    { wd:{{ q }} wdt:P50 | wdt:P2093 [] . BIND("work" AS ?aspect) }
    }
    `;
  }
     settings = {
	 headers: { Accept: 'application/sparql-results+json' },
	 data: { query: query }
     };
     
      $.ajax(endpointUrl, settings).then(function (data) {
        var currentAspect = window.location.pathname.split("/")[1];
        createDropdownButton("aspect-chooser", 'aspectMenuButton', currentAspect, data, "{{q}}")

        if (data.results.bindings.length > 1) {
          addDropdownList("aspect-chooser", 'aspectMenuList', currentAspect, data)
        }
      }).then(function () {
        if ("{{q2}}".length) {
          var endpointUrl = 'https://query.wikidata.org/sparql';
          var query = "SELECT DISTINCT ?aspect WHERE {"
          query += '{ [] wdt:P921 wd:{{ q }} . BIND("topic" AS ?aspect) }    }';

          settings = {
            headers: { Accept: 'application/sparql-results+json' },
            data: { query: query }
          };

          $.ajax(endpointUrl, settings).then(function (data) {
            var currentAspect = window.location.pathname.split("/")[1];
            var aspectLabel = " / <a href='/" + currentAspect + "/{{q}}'>{{q}}</a> / "   
            document.getElementById("aspect-chooser-label").innerHTML = aspectLabel;

            var currentSubAspect = window.location.pathname.split("/")[3];
            document.querySelectorAll("#aspectMenuList a").forEach((link) => link.href += "/" + currentSubAspect + "/{{q2}}")

            createDropdownButton("aspect-chooser", 'aspectMenuButton', currentSubAspect, data, "{{q2}}")

            if (data.results.bindings.length > 1) {
              addDropdownList("aspect-chooser", 'aspectMenuList', currentSubAspect, data)
            }
          })
        }
      });

      function createDropdownButton(parent, id, currentAspect, data, q) {        
        var aspectDropdown = document.createElement('button');
        aspectDropdown.type = 'button';
        aspectDropdown.id = id;
        aspectDropdown.classList = 'btn btn-outline-secondary';
        if (data.results.bindings.length > 1) {
          aspectDropdown.classList.add('dropdown-toggle');
          aspectDropdown.setAttribute('data-toggle', 'dropdown');
          aspectDropdown.setAttribute('aria-haspopup', 'true');
          aspectDropdown.setAttribute('aria-expanded', 'false');
        }
        aspectDropdown.innerText = currentAspect;
        document.getElementById(parent).append(aspectDropdown);

        aspectDropdown.insertAdjacentHTML("afterend",
          '<span id="aspect-chooser-label" style="color: #6C757D; vertical-align: middle;margin: 2px;"> / '+ q + '</span>')
      }

      function addDropdownList(parent, id, currentAspect, data) {        
        var aspectDropdownMenu = document.createElement('div');
        aspectDropdownMenu.classList = 'dropdown-menu';
        aspectDropdownMenu.setAttribute('aria-labelledby', 'aspectMenuButton');
        aspectDropdownMenu.id = id

        data.results.bindings.forEach(function (entry) {
          var aspect = entry.aspect.value;
          if (aspect != currentAspect) {
            var dropdownItem = document.createElement('a');
            dropdownItem.classList = 'dropdown-item';
            dropdownItem.href = "{{ url_for('app.index') }}" + aspect + '/{{ q }}';
            dropdownItem.innerText = aspect;
            aspectDropdownMenu.append(dropdownItem);
          }
        });

        document.getElementById(parent).append(aspectDropdownMenu);
      }

     // this query opens a subpage for the Wikidata item, e.g. as cito subpage
     var endpointUrl = 'https://query.wikidata.org/sparql';
     var query = `
    SELECT DISTINCT ?aspectsubpage
    WHERE {
    { [] pq:P3712 / wdt:P31 wd:Q96471816 ; ps:P2860 / wdt:P1433 wd:{{ q }} . BIND("venue-cito" AS ?aspectsubpage) }
    UNION
    { [] pq:P3712 / wdt:P31 wd:Q96471816 ; ps:P2860 wd:{{ q }} . BIND("work-cito" AS ?aspectsubpage) }
    }
    `;
     settings = {
	 headers: { Accept: 'application/sparql-results+json' },
	 data: { query: query }
     };

     $.ajax( endpointUrl, settings ).then( function ( data ) {
	 data.results.bindings.forEach(function(entry) {
	     var props = entry.aspectsubpage.value.split("-");
	     var aspect = props[0];
	     var subpage = props[1];
	     $( '#aspect-chooser' ).append(
		 `<a role="button"
		     class="btn btn-outline-dark btn-sm"
                     href="{{ url_for('app.index') }}` + aspect + '/' + '{{ q }}' + '/' + subpage + '">' + subpage + '</a> ' );
	 });
     } );


     /* Wembedder */
     var wembedderUrl = "https://wembedder.toolforge.org/api/most-similar/{{ q }}";
     $.ajax({
	 url: wembedderUrl,
	 success: function (data) {
	     var html = `<hr><span data-toogle="tooltip" title="Related items from Wembedder knowledge graph embedding.">Related:</span> `; 
	     $( '#wembedder' ).append(html);

	     // Make list with results
	     data.most_similar.forEach(function(entry, idx, array) {
		 var listed_q = entry.item;
		 var language = 'en';

		 if (idx !== 0) {
		     $( '#wembedder' ).append( ' &middot; ');
		 }

		 var html = '<a href="../' + listed_q + '"><span id="wembedder-result-' + listed_q + '">' + listed_q + '</span></a> '
		 $( '#wembedder' ).append( html );

		 // Convert Q identifier to labels
                 $.getJSON("https://www.wikidata.org/w/api.php?callback=?", {
                     action: "wbgetentities",
                     ids: listed_q,
                     language: language,
                     uselang: language,
                     format: "json",
                     strictlanguage: true,
                 }, function (data) {
                     if (listed_q in data.entities) {
                         label = entityToLabel(data.entities[listed_q],
                                               language=language);
                         $('#wembedder-result-' + listed_q).empty();
                         $('#wembedder-result-' + listed_q).text(label);
                     }
		 });
	     });
	     $( '#wembedder' ).append( '<hr>' );
	 }
     });
  {% endif %}

  {% if p %} 
  var url = 'https://www.wikidata.org/w/api.php?action=wbgetentities&ids=' +
      '{{ p }}' +
      '&format=json&callback=?';
    $.getJSON(url, function (data) {
      var item = data.entities["{{ p }}"];
      if ('en' in item.labels) {
        $("h1").text("Property: " + item.labels.en.value);
      }
      if ('en' in item.descriptions) {
        $("#intro").text(item.descriptions.en.value);
      }
      $("h1").append(' (<a href="https://www.wikidata.org/wiki/Property:{{ p }}">{{ p }}</a>)');
    })
  {% endif %}

  $(document).ready(function () {
    $('#searchterm').autoComplete({
      minLength: 2,
      resolver: 'custom',
      events: {
        search: debounce((searchTerm, callback) => {
          var url = "https://www.wikidata.org/w/api.php?callback=?";
          var settings = {
            dataType: 'jsonp',
            data: {
              search: searchTerm,
              action: "wbsearchentities",
              language: "en",
              uselang: "en",
              format: "json",
              strictlanguage: true
            }
          };

          $.ajax(url, settings).then(function (data) {
            if (data.search.length) {
              let results = ['Show all results for "' + searchTerm + '"']
              for (let item of data.search) {
                results.push(item.label + " - " + item.description + " (" + item.title + ")");
              }
              callback(results)
            } else {
              callback([])
            }
          });
        }, 200)
      }
    });

    $("#searchterm").on("autocomplete.select", (event, item) => { handleSearch(item) });

    $("#searchterm").on("keydown", function (event) {
      switch (event.key) {
        case "Enter":
          handleSearch(this.value);
          break;
        default:
      }
    });

    $("#searchbutton").on("click", () => { handleSearch(document.getElementById("searchterm").value) })

    function handleSearch(item) {
      let q_id = item.match(/ \((Q\d+)\)$/)
      if (q_id) {
        window.location.href = "/" + q_id[1];
      } else {
        let search_text = item.match(/Show all results for "(.+)"$/)
        if (search_text) {
          window.location.href = "/search?q=" + search_text[1];
        } else {
          window.location.href = "/search?q=" + item;
        }
      }
    }

    function debounce(callback, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(function () {
          callback.apply(this, args);
        }, wait);
      };
    }

     // Add table of content
  var headings = document.querySelectorAll("h2,h3");
  if (headings.length >= 4) {
    var tocParent = document.createElement("div");
    tocParent.className = "table-of-contents"

    var toc = document.createElement("div");

    tocTitle = document.createElement("b");
    tocTitle.innerText = "Table of Contents"
    toc.appendChild(tocTitle)

    var tocList = document.createElement("ul");
    var sublist = "";
    for (let i = 0; i < headings.length; i++) {
      const element = headings[i];
      if (!element.id) {
        element.id = element.innerText.replaceAll(" ", "-");
      }
      if (element.tagName === "H3" && !sublist) {
        var sublist = document.createElement("ul");
      }
      tocListItem = document.createElement("li");

      tocEntry = document.createElement("a");
      tocEntry.setAttribute("href", "#" + element.id);
      tocEntry.innerText = headings[i].innerText;

      tocListItem.appendChild(tocEntry);

      if (element.tagName === "H3") {
        sublist.appendChild(tocListItem);
        if (i == headings.length - 1) {
          tocList.appendChild(sublist);
        }
      } else {
        if (sublist) {
          tocList.appendChild(sublist);
          sublist = "";
        }
        tocList.appendChild(tocListItem);
      }
    }

    toc.appendChild(tocList)

    var itemImage = document.createElement("img");
    itemImage.id = "item-image";
    itemImage.alt = "";

    tocParent.appendChild(toc);
    tocParent.appendChild(itemImage);
    document.querySelector("h2").insertAdjacentElement("beforebegin", tocParent)
    
    itemImage.height = toc.clientHeight
  }

    // Add anchor links to all headings
    var headers = document.querySelectorAll('h2[id], h3[id]')
    if (headers) {
      headers.forEach(element => {
        var title = element.innerText;
        element.removeChild(element.childNodes[0])
        element.insertAdjacentHTML('afterbegin', `<a href="#${element.id}" class="hlink"  ariaLabel="Anchor">${title}</a>`)
      })
    }

     {% block in_ready %}{% endblock %}
 });

</script>

{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg" style="max-width: 1200px;">
  <a class="navbar-brand" href="{{ url_for('app.index') }}"><img
      src="{{ url_for('static', filename='images/scholia_wordmark.svg') }}" width="112px" height="24px"
      alt="Scholia"></a>
  <button class="navbar-light navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
	<li class="nav-item"><a class="nav-link" href="{{ url_for('app.show_author_index') }}">Author</a></li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="workDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Work
    </a>
    <div class="dropdown-menu" aria-labelledby="workDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_work_index') }}">Work</a>
      <a class="dropdown-item" href="{{ url_for('app.show_venue_index') }}">Venue</a>
      <a class="dropdown-item" href="{{ url_for('app.show_series_index') }}">Series</a>
      <a class="dropdown-item" href="{{ url_for('app.show_catalogue_index') }}">Catalogue</a>
      <a class="dropdown-item" href="{{ url_for('app.show_publisher_index') }}">Publisher</a>
      <a class="dropdown-item" href="{{ url_for('app.show_printer_index') }}">Printer</a>
    </div>
	</li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="organisationDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Organization
    </a>
    <div class="dropdown-menu" aria-labelledby="organisationDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_organization_index') }}">Organization</a>
      <a class="dropdown-item" href="{{ url_for('app.show_publisher_index') }}">Publisher</a>
      <a class="dropdown-item" href="{{ url_for('app.show_printer_index') }}">Printer</a>
      <a class="dropdown-item" href="{{ url_for('app.show_sponsor_index') }}">Sponsor</a>
    </div>
	</li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="locationDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Location
    </a>
    <div class="dropdown-menu" aria-labelledby="locationDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_location_index') }}">Location</a>
      <a class="dropdown-item" href="{{ url_for('app.show_country_index') }}">Country</a>
    </div>
	</li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="eventDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Event
    </a>
    <div class="dropdown-menu" aria-labelledby="eventDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_event_index') }}">Event</a>
      <a class="dropdown-item" href="{{ url_for('app.show_event_series_index') }}">Event series</a>
    </div>
	</li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="projectDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Project
    </a>
    <div class="dropdown-menu" aria-labelledby="projectDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_clinical_trial_index') }}">Clinical trial</a>
      <a class="dropdown-item" href="{{ url_for('app.show_project_index') }}">Project</a>
    </div>

	</li>
	<li class="nav-item"><a class="nav-link" href="{{ url_for('app.show_award_index') }}">Award</a></li>
  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="topicDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Topic
    </a>
    <div class="dropdown-menu" aria-labelledby="projectDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_topic_index') }}">General</a>
      <a class="dropdown-item" href="{{ url_for('app.show_disease_index') }}">Disease</a>
      <a class="dropdown-item" href="{{ url_for('app.show_taxon_index') }}">Taxon</a>
      <a class="dropdown-item" href="{{ url_for('app.show_gene_index') }}">Gene</a>
      <a class="dropdown-item" href="{{ url_for('app.show_protein_index') }}">Protein</a>
      <a class="dropdown-item" href="{{ url_for('app.show_pathway_index') }}">Pathway</a>
      <a class="dropdown-item" href="{{ url_for('app.show_chemical_index') }}">Chemical</a>
      <a class="dropdown-item" href="{{ url_for('app.show_chemical_element_index') }}">Chemical element</a>
      <a class="dropdown-item" href="{{ url_for('app.show_chemical_class_index') }}">Chemical class</a>
      <a class="dropdown-item" href="{{ url_for('app.show_lexeme_index') }}">Lexeme</a>
      <a class="dropdown-item" href="{{ url_for('app.show_use_index') }}">Use</a>
    </div>
  </li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="toolsDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Tools
    </a>
    <div class="dropdown-menu" aria-labelledby="toolsDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_arxiv_to_quickstatements') }}">Arxiv to Quickstatements</a>
      <a class="dropdown-item" href="{{ url_for('app.show_q_to_bibliography_templates') }}">Q to Bibliography templates</a>
      <a class="dropdown-item" href="{{ url_for('app.show_text_to_topics') }}">Text to topics</a>
    </div>
	</li>
	<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="helpDropdown" role="button" data-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      Help
    </a>
    <div class="dropdown-menu" aria-labelledby="helpDropdown">
      <a class="dropdown-item" href="{{ url_for('app.show_about') }}">About</a>
      <a class="dropdown-item" href="{{ url_for('app.index_statistics') }}">Statistics</a>
      <a class="dropdown-item" href="{{ url_for('app.show_faq') }}">FAQ</a>
    </div>
	</li>
    
    </ul>
    {% block nav_search %}
    <div class='nav nav-search'>
        <input class="form-control" type="text" id="searchterm"/>
    </div>
    {% endblock %}
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="content">
<div class="container d-flex justify-content-between">
    <div class="dropdown" id="aspect-chooser">
    </div>
    <a id='curation-link' role="button" class="btn btn-outline-secondary d-none">Add missing info</a>
</div>
<div class="container">
    {% block page_content %}{% endblock %}
</div>
</div>
<div class="container footer">
    <hr>
    Data from <a href="https://www.wikidata.org">Wikidata</a> and
    <a href="https://en.wikipedia.org">English Wikipedia</a>
    |
    Code from
    <a href="https://github.com/WDscholia/scholia">GitHub repository</a>
    |
    Hosted on   <a href="https://toolforge.org/">Wikimedia Toolforge</a>,
    a <a href="https://wikimediafoundation.org">Wikimedia Foundation</a> service
    |
    License for content: CC0 for data, CC-BY-SA for text and media
    |
    Report technical problems at Scholia's
    <a href="https://github.com/WDscholia/scholia/issues">Issues</a> GitHub page.
    |
    Follow us on <a href="https://twitter.com/wdscholia">Twitter</a>.
    <hr>
  </div>
{% endblock %}

<script type="text/javascript">
    
</script>
